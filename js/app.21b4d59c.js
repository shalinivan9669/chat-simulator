(function(){"use strict";var e={4349:function(e,t,s){var a=s(5130),n=s(6768);const r={id:"app"};function i(e,t,s,a,i,o){const c=(0,n.g2)("router-view");return(0,n.uX)(),(0,n.CE)("div",r,[(0,n.bF)(c)])}var o=s(657);const c=(0,o.nY)("user",{state:()=>({currentUser:null}),actions:{setUser(e){this.currentUser=e,sessionStorage.setItem("currentUser",JSON.stringify(e))},loadUserFromStorage(){const e=sessionStorage.getItem("currentUser");e&&(this.currentUser=JSON.parse(e))}}});var u={name:"App",created(){const e=c();e.loadUserFromStorage()}},h=s(1241);const l=(0,h.A)(u,[["render",i]]);var d=l,m=s(973),g=s(4232);const p={class:"login"},f=["onClick"];function v(e,t,s,a,r,i){return(0,n.uX)(),(0,n.CE)("div",p,[t[0]||(t[0]=(0,n.Lk)("h1",null,"Выберите пользователя",-1)),(0,n.Lk)("ul",null,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(r.users,(e=>((0,n.uX)(),(0,n.CE)("li",{key:e.id},[(0,n.Lk)("button",{onClick:t=>i.selectUser(e)},(0,g.v_)(e.name),9,f)])))),128))])])}s(4114);var b={data(){return{users:[{id:1,name:"Алиса"},{id:2,name:"Адиль"},{id:3,name:"Каролина"}]}},methods:{selectUser(e){const t=c();t.setUser(e),this.$router.push("/chats")}}};const C=(0,h.A)(b,[["render",v],["__scopeId","data-v-4d94e234"]]);var y=C;const k={class:"chat-header text-center mb-4 p-3"},w={class:"text-white"},L={class:"chat-last-message mb-0"},_={class:"text-right"},M={key:0,class:"unread-count"},I={class:"chat-time mb-0"};function U(e,t,s,a,r,i){const o=(0,n.g2)("b-list-group-item"),c=(0,n.g2)("b-list-group"),u=(0,n.g2)("b-col"),h=(0,n.g2)("b-row"),l=(0,n.g2)("b-container");return(0,n.uX)(),(0,n.Wv)(l,{fluid:"",class:"pt-4 pb-4 chat-container"},{default:(0,n.k6)((()=>[(0,n.bF)(h,{class:"justify-content-center"},{default:(0,n.k6)((()=>[(0,n.bF)(u,{cols:"12",md:"8",lg:"6"},{default:(0,n.k6)((()=>[(0,n.Lk)("div",k,[(0,n.Lk)("h1",w,"Добро пожаловать, "+(0,g.v_)(i.user.name)+"!",1),t[0]||(t[0]=(0,n.Lk)("h2",{class:"text-white-50"},"Выберите чат:",-1))]),(0,n.bF)(c,{class:"shadow chat-list"},{default:(0,n.k6)((()=>[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(i.availableChats,(e=>((0,n.uX)(),(0,n.Wv)(o,{key:e.id,onClick:t=>i.selectChat(e.id),class:"chat-item d-flex justify-content-between align-items-center"},{default:(0,n.k6)((()=>[(0,n.Lk)("div",null,[(0,n.Lk)("strong",null,(0,g.v_)(i.getChatParticipants(e)),1),(0,n.Lk)("p",L,(0,g.v_)(i.getLastMessage(e)),1)]),(0,n.Lk)("div",_,[i.getUnreadCount(e)?((0,n.uX)(),(0,n.CE)("span",M,(0,g.v_)(i.getUnreadCount(e)),1)):(0,n.Q3)("",!0),(0,n.Lk)("p",I,(0,g.v_)(i.getLastMessageTime(e)),1)])])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1})])),_:1})])),_:1})}var O=s(9666);const S=new O.Ay("ChatDatabase");function x(e,t,s,a){return S.messages.add({chatId:e,sender:t,text:s,timestamp:a.time,fullDate:a.fullDate,read:!1})}function E(e){return S.messages.where({chatId:e}).modify({read:!0})}function N(e){return S.messages.where({chatId:e}).sortBy("timestamp")}S.version(1).stores({messages:"++id, chatId, sender, text, timestamp, fullDate",chats:"++id, participants"});var j={data(){return{chats:[{id:1,participants:["Алиса","Адиль"],messages:[]},{id:2,participants:["Алиса","Каролина"],messages:[]},{id:3,participants:["Адиль","Каролина"],messages:[]}],broadcastChannel:null}},computed:{user(){const e=c();return e.currentUser},availableChats(){return this.chats.filter((e=>e.participants.includes(this.user.name)))}},methods:{getChatParticipants(e){return e.participants.filter((e=>e!==this.user.name)).join(", ")},async selectChat(e){await E(e),this.$router.push({name:"ChatWindow",params:{chatId:e}}),this.loadChats()},async loadChats(){this.chats.forEach((async e=>{e.messages=await N(e.id)}))},getLastMessage(e){if(e.messages.length>0){const t=e.messages[e.messages.length-1];return`${t.text}`}return"No messages yet"},getLastMessageTime(e){if(e.messages.length>0){const t=e.messages[e.messages.length-1];return t.timestamp||""}return""},getUnreadCount(e){return e.messages.filter((e=>e.sender!==this.user.name&&!e.read)).length},updateChatWithNewMessage(e,t){const s=this.chats.find((t=>t.id===e));s&&s.messages.push(t)}},created(){this.loadChats(),this.broadcastChannel=new BroadcastChannel("chat_channel"),this.broadcastChannel.onmessage=e=>{const{chatId:t,message:s}=e.data;this.updateChatWithNewMessage(t,s)}},beforeUnmount(){this.broadcastChannel&&this.broadcastChannel.close()}};const X=(0,h.A)(j,[["render",U],["__scopeId","data-v-23c53af6"]]);var F=X;const D={key:0},P={class:"message-list"},B={class:"message-content"},T=["title"],W={class:"input-group mt-3"},$={key:1};function A(e,t,s,r,i,o){return o.chat?((0,n.uX)(),(0,n.CE)("div",D,[(0,n.Lk)("h1",null,"Чат с "+(0,g.v_)(o.chatParticipants),1),(0,n.Lk)("ul",P,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(o.chat.messages,((e,t)=>((0,n.uX)(),(0,n.CE)("li",{key:t,class:(0,g.C4)([{"my-message":e.sender===o.user.name,"other-message":e.sender!==o.user.name},"message-item"])},[(0,n.Lk)("div",B,[(0,n.Lk)("strong",null,(0,g.v_)(e.sender)+":",1),(0,n.eW)(" "+(0,g.v_)(e.text),1)]),(0,n.Lk)("div",{class:"message-timestamp",title:e.fullDate},(0,g.v_)(e.timestamp),9,T)],2)))),128))]),(0,n.Lk)("div",W,[(0,n.bo)((0,n.Lk)("input",{"onUpdate:modelValue":t[0]||(t[0]=e=>i.newMessage=e),placeholder:"Напишите ваше сообщение",class:"form-control message-input"},null,512),[[a.Jo,i.newMessage]]),(0,n.Lk)("button",{onClick:t[1]||(t[1]=(...e)=>o.sendMessage&&o.sendMessage(...e)),class:"btn btn-primary"}," Отправить ")])])):((0,n.uX)(),(0,n.CE)("div",$,t[2]||(t[2]=[(0,n.Lk)("p",null,"Чат не найден.",-1)])))}const J=(0,o.nY)("chat",{state:()=>({chats:[{id:1,participants:["Алиса","Адиль"],messages:[]},{id:2,participants:["Алиса","Каролина"],messages:[]},{id:3,participants:["Адиль","Каролина"],messages:[]}]}),actions:{getChatById(e){return this.chats.find((t=>t.id===e))}}});var K={data(){return{newMessage:"",broadcastChannel:null,isLoading:!0}},computed:{user(){const e=c(),t=localStorage.getItem("currentUser");return!e.currentUser&&t&&(e.currentUser=JSON.parse(t)),e.currentUser},chat(){const e=J(),t=Number(this.$route.params.chatId);return e.getChatById(t)},chatParticipants(){return this.chat?this.chat.participants.filter((e=>e!==this.user.name)).join(", "):""}},methods:{formatMessageTime(e){const t={hour:"2-digit",minute:"2-digit"},s={weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"};return{time:e.toLocaleTimeString([],t),fullDate:e.toLocaleDateString("ru-RU",s)}},async sendMessage(){if(""!==this.newMessage.trim())try{const e=new Date,t=this.formatMessageTime(e),s={sender:this.user.name,text:this.newMessage,timestamp:t.time,fullDate:t.fullDate};this.chat.messages.push(s),await x(this.chat.id,this.user.name,this.newMessage,t),this.broadcastChannel.postMessage({chatId:this.chat.id,message:s}),this.newMessage=""}catch(e){console.error("Ошибка при отправке сообщения: ",e)}},async loadMessages(){try{const e=await N(this.chat.id);this.chat.messages=e,this.isLoading=!1}catch(e){console.error("Ошибка при загрузке сообщений: ",e)}},receiveMessage(e){try{if(e.data.chatId===this.chat.id){const t=e.data.message;this.chat.messages.push(t),"granted"!==Notification.permission||document.hasFocus()||this.showNotification(t.sender,t.text)}}catch(t){console.error("Ошибка при получении сообщения через BroadcastChannel: ",t)}},showNotification(e,t){try{new Notification(`Новое сообщение от ${e}`,{body:t})}catch(s){console.error("Ошибка при показе уведомления: ",s)}}},async created(){try{this.broadcastChannel=new BroadcastChannel("chat_channel"),this.broadcastChannel.onmessage=this.receiveMessage;const e=Number(this.$route.params.chatId),t=J(),s=t.getChatById(e);s?(this.chat=s,await this.loadMessages()):this.$router.push("/chats"),Notification.requestPermission().then((e=>{"granted"===e?console.log("Пользователь разрешил уведомления"):console.log("Пользователь отклонил уведомления")})),localStorage.setItem("currentUser",JSON.stringify(this.user))}catch(e){console.error("Ошибка в created(): ",e)}},beforeUnmount(){try{this.broadcastChannel&&this.broadcastChannel.close()}catch(e){console.error("Ошибка при закрытии BroadcastChannel: ",e)}}};const q=(0,h.A)(K,[["render",A],["__scopeId","data-v-9e911dfa"]]);var Y=q;const Q=[{path:"/",name:"Login",component:y},{path:"/chats",name:"ChatList",component:F},{path:"/chats/:chatId",name:"ChatWindow",component:Y}],R=(0,m.aE)({history:(0,m.Bt)(),routes:Q});var V=R;s(8077);const z=(0,o.Ey)(),G=(0,a.Ef)(d);G.use(z),G.use(V),G.mount("#app"),Notification.requestPermission().then((e=>{"granted"===e?console.log("Разрешение на уведомления получено"):console.log("Уведомления отклонены")}))}},t={};function s(a){var n=t[a];if(void 0!==n)return n.exports;var r=t[a]={exports:{}};return e[a].call(r.exports,r,r.exports,s),r.exports}s.m=e,function(){var e=[];s.O=function(t,a,n,r){if(!a){var i=1/0;for(h=0;h<e.length;h++){a=e[h][0],n=e[h][1],r=e[h][2];for(var o=!0,c=0;c<a.length;c++)(!1&r||i>=r)&&Object.keys(s.O).every((function(e){return s.O[e](a[c])}))?a.splice(c--,1):(o=!1,r<i&&(i=r));if(o){e.splice(h--,1);var u=n();void 0!==u&&(t=u)}}return t}r=r||0;for(var h=e.length;h>0&&e[h-1][2]>r;h--)e[h]=e[h-1];e[h]=[a,n,r]}}(),function(){s.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return s.d(t,{a:t}),t}}(),function(){s.d=function(e,t){for(var a in t)s.o(t,a)&&!s.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})}}(),function(){s.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){s.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){var e={524:0};s.O.j=function(t){return 0===e[t]};var t=function(t,a){var n,r,i=a[0],o=a[1],c=a[2],u=0;if(i.some((function(t){return 0!==e[t]}))){for(n in o)s.o(o,n)&&(s.m[n]=o[n]);if(c)var h=c(s)}for(t&&t(a);u<i.length;u++)r=i[u],s.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return s.O(h)},a=self["webpackChunkchat_simulator"]=self["webpackChunkchat_simulator"]||[];a.forEach(t.bind(null,0)),a.push=t.bind(null,a.push.bind(a))}();var a=s.O(void 0,[504],(function(){return s(4349)}));a=s.O(a)})();
//# sourceMappingURL=app.21b4d59c.js.map